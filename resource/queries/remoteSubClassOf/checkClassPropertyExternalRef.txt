#check whether something is an external reference or we having references to not type objects
SELECT *
FROM <%3$s>
WHERE
{
  {
    ?subj wdt:P31 <%1$s> .
  }
  UNION
  {
    ?subj wdt:P279+ <%1$s> .
  }
  ?subj <%2$s> ?target .
  ?target ?pred ?obj .
  FILTER NOT EXISTS
  {
    ?target wdt:P31 ?type .
  }
}
LIMIT 1
